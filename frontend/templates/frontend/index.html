<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–≤—Ç–æ—Å–µ—Ä–≤—ñ—Å - –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Login Section -->
    <div id="loginSection" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
            <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">üöó –ê–≤—Ç–æ—Å–µ—Ä–≤—ñ—Å</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                <button onclick="login()" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-colors font-medium">
                    –£–≤—ñ–π—Ç–∏
                </button>
                <div id="loginError" class="text-red-600 text-sm text-center hidden"></div>
            </div>
        </div>
    </div>

    <!-- Main App Section -->
    <div id="appSection" class="hidden p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="bg-indigo-600 p-3 rounded-xl">
                            <span class="text-white text-2xl">üöó</span>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900">–ê–≤—Ç–æ—Å–µ—Ä–≤—ñ—Å</h1>
                            <p class="text-gray-500">–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è–º</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span id="userInfo" class="text-gray-700 font-medium"></span>
                        <button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                            –í–∏–π—Ç–∏
                        </button>
                    </div>
                </div>
            </div>

            <!-- Cars Section -->
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">–ú–æ—ó –∞–≤—Ç–æ–º–æ–±—ñ–ª—ñ</h2>
                    <button onclick="showAddCarModal()" class="flex items-center gap-2 bg-indigo-600 text-white px-6 py-3 rounded-xl hover:bg-indigo-700 transition-colors shadow-lg">
                        ‚ûï –î–æ–¥–∞—Ç–∏ –∞–≤—Ç–æ
                    </button>
                </div>
                <div id="carsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Cars will be loaded here -->
                </div>
            </div>

            <!-- Services Section -->
            <div id="servicesSection" class="bg-white rounded-2xl shadow-xl p-6 hidden">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">–û–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è</h2>
                        <p id="selectedCarInfo" class="text-gray-600"></p>
                    </div>
                    <button onclick="showAddServiceModal()" class="flex items-center gap-2 bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700 transition-colors shadow-lg">
                        üîß –î–æ–¥–∞—Ç–∏ —Ä–æ–±–æ—Ç—É
                    </button>
                </div>
                <div id="servicesList" class="space-y-3">
                    <!-- Services will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add Car Modal -->
    <div id="addCarModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md m-4">
            <h3 class="text-2xl font-bold text-gray-900 mb-6">–î–æ–¥–∞—Ç–∏ –∞–≤—Ç–æ–º–æ–±—ñ–ª—å</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ë—Ä–µ–Ω–¥</label>
                    <select id="carBrand" onchange="loadModels()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="">–û–±–µ—Ä—ñ—Ç—å –±—Ä–µ–Ω–¥</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ú–æ–¥–µ–ª—å</label>
                    <select id="carModel" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –±—Ä–µ–Ω–¥</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ü–æ—á–∞—Ç–∫–æ–≤–∏–π –ø—Ä–æ–±—ñ–≥ (–∫–º)</label>
                    <input type="number" id="initialMileage" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ü–æ—Ç–æ—á–Ω–∏–π –ø—Ä–æ–±—ñ–≥ (–∫–º)</label>
                    <input type="number" id="currentMileage" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="addCar()" class="flex-1 bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-colors font-medium">
                    –î–æ–¥–∞—Ç–∏
                </button>
                <button onclick="closeModal('addCarModal')" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition-colors font-medium">
                    –°–∫–∞—Å—É–≤–∞—Ç–∏
                </button>
            </div>
        </div>
    </div>

    <!-- Add Service Modal -->
    <div id="addServiceModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md m-4">
            <h3 class="text-2xl font-bold text-gray-900 mb-6">–î–æ–¥–∞—Ç–∏ —Ä–æ–±–æ—Ç—É</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–û–ø–∏—Å —Ä–æ–±–æ—Ç–∏</label>
                    <input type="text" id="workDescription" placeholder="–ó–∞–º—ñ–Ω–∞ –º–∞—Å–ª–∞, —Ñ—ñ–ª—å—Ç—Ä—ñ–≤..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ì–æ–¥–∏–Ω–∏ —Ä–æ–±–æ—Ç–∏</label>
                    <input type="number" step="0.5" id="workHours" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–î–∞—Ç–∞</label>
                    <input type="date" id="scheduledDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="addService()" class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors font-medium">
                    –î–æ–¥–∞—Ç–∏
                </button>
                <button onclick="closeModal('addServiceModal')" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition-colors font-medium">
                    –°–∫–∞—Å—É–≤–∞—Ç–∏
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:8000/api';
        let token = null;
        let selectedCarId = null;

        // Auth functions
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_URL}/auth/signin/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    token = data.access;
                    document.getElementById('userInfo').textContent = `üë§ ${username}`;
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('appSection').classList.remove('hidden');
                    loadBrands();
                    loadCars();
                } else {
                    document.getElementById('loginError').textContent = '–ù–µ–≤—ñ—Ä–Ω–∏–π –ª–æ–≥—ñ–Ω –∞–±–æ –ø–∞—Ä–æ–ª—å';
                    document.getElementById('loginError').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Login error:', error);
                document.getElementById('loginError').textContent = '–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è';
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        function logout() {
            token = null;
            selectedCarId = null;
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('appSection').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // API calls
        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }
            
            const response = await fetch(`${API_URL}${endpoint}`, options);
            if (!response.ok) throw new Error('API call failed');
            return response.json();
        }

        // Load data
        async function loadBrands() {
            try {
                const response = await apiCall('/cars/brands/');
                const select = document.getElementById('carBrand');
                select.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –±—Ä–µ–Ω–¥</option>';
                
                // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ response.results –∑–∞–º—ñ—Å—Ç—å response
                response.results.forEach(brand => {
                    select.innerHTML += `<option value="${brand.id}">${brand.title}</option>`;
                });
            } catch (error) {
                console.error('Error loading brands:', error);
            }
        }

        async function loadModels() {
            const brandId = document.getElementById('carBrand').value;
            const select = document.getElementById('carModel');
            
            if (!brandId) {
                select.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –º–æ–¥–µ–ª—å</option>';
                return;
            }
            
            try {
                const response = await apiCall(`/cars/models/?brand=${brandId}`);
                
                const options = ['<option value="">–û–±–µ—Ä—ñ—Ç—å –º–æ–¥–µ–ª—å</option>'];
                response.results.forEach(model => {
                    options.push(`<option value="${model.id}">${model.title}</option>`);
                });
                select.innerHTML = options.join('');
            } catch (error) {
                console.error('Error loading models:', error);
            }
        }

        async function loadCars() {
            try {
                const response = await apiCall('/cars/');
                const container = document.getElementById('carsList');
                
                if (response.results.length === 0) {
                    container.innerHTML = '<p>–ù–µ–º–∞—î –∞–≤—Ç–æ–º–æ–±—ñ–ª—ñ–≤</p>';
                    return;
                }
                
                const carsHTML = response.results.map(car => `
                    <div class="car-card">
                        <img src="${car.logo}" alt="${car.brand}">
                        <h3>${car.brand} ${car.model}</h3>
                        <p>–ü—Ä–æ–±—ñ–≥: ${car.mileage} –∫–º</p>
                        <p>–ü–æ—á–∞—Ç–∫–æ–≤–∏–π –ø—Ä–æ–±—ñ–≥: ${car.initial_mileage} –∫–º</p>
                        <p>–û–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(car.updated_mileage_at).toLocaleDateString('uk-UA')}</p>
                    </div>
                `).join('');
                
                container.innerHTML = carsHTML;
            } catch (error) {
                console.error('Error loading cars:', error);
            }
        }

        async function loadServices(carId) {
            try {
                const services = await apiCall(`/cars/services/?car=${carId}`);
                const container = document.getElementById('servicesList');
                container.innerHTML = '';
                
                if (services.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">–ù–µ–º–∞—î —Ä–æ–±—ñ—Ç. –î–æ–¥–∞–π—Ç–µ –Ω–æ–≤–µ –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è!</p>';
                    return;
                }
                
                const statusColors = {
                    'pending': 'bg-yellow-100 text-yellow-800',
                    'in_progress': 'bg-blue-100 text-blue-800',
                    'completed': 'bg-green-100 text-green-800'
                };
                
                const statusLabels = {
                    'pending': '–û—á—ñ–∫—É—î',
                    'in_progress': '–í —Ä–æ–±–æ—Ç—ñ',
                    'completed': '–í–∏–∫–æ–Ω–∞–Ω–æ'
                };
                
                services.forEach(service => {
                    container.innerHTML += `
                        <div class="border border-gray-200 rounded-xl p-5 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h4 class="font-bold text-lg text-gray-900">${service.work_description}</h4>
                                    <div class="flex gap-4 mt-2 text-sm text-gray-600">
                                        <span>‚è±Ô∏è ${service.hours} –≥–æ–¥</span>
                                        <span>üìÖ ${service.scheduled_date}</span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <select onchange="updateServiceStatus(${service.id}, this.value)" class="px-3 py-1 rounded-lg text-sm font-medium ${statusColors[service.status]} border-0">
                                        <option value="pending" ${service.status === 'pending' ? 'selected' : ''}>–û—á—ñ–∫—É—î</option>
                                        <option value="in_progress" ${service.status === 'in_progress' ? 'selected' : ''}>–í —Ä–æ–±–æ—Ç—ñ</option>
                                        <option value="completed" ${service.status === 'completed' ? 'selected' : ''}>–í–∏–∫–æ–Ω–∞–Ω–æ</option>
                                    </select>
                                    <button onclick="deleteService(${service.id})" class="text-red-500 hover:text-red-700 p-2">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } catch (error) {
                console.error('Error loading services:', error);
            }
        }

        // Actions
        function selectCar(carId) {
            selectedCarId = carId;
            loadCars();
            loadServices(carId);
            
            const car = document.querySelector(`[onclick="selectCar(${carId})"]`);
            const carInfo = car.querySelector('h3').textContent;
            document.getElementById('selectedCarInfo').textContent = `–ê–≤—Ç–æ–º–æ–±—ñ–ª—å: ${carInfo}`;
            document.getElementById('servicesSection').classList.remove('hidden');
        }

        async function addCar() {
            const data = {
                carBrandId: parseInt(document.getElementById('carBrand').value),
                carModelId: parseInt(document.getElementById('carModel').value),
                initial_mileage: parseInt(document.getElementById('initialMileage').value),
                mileage: parseInt(document.getElementById('currentMileage').value)
            };
            
            try {
                await apiCall('/cars/', 'POST', data);
                closeModal('addCarModal');
                loadCars();
            } catch (error) {
                console.error('Error adding car:', error);
                alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ –∞–≤—Ç–æ–º–æ–±—ñ–ª—è');
            }
        }

        async function deleteCar(carId, event) {
            event.stopPropagation();
            if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∞–≤—Ç–æ–º–æ–±—ñ–ª—å?')) return;
            
            try {
                await apiCall(`/cars/${carId}/`, 'DELETE');
                if (selectedCarId === carId) {
                    selectedCarId = null;
                    document.getElementById('servicesSection').classList.add('hidden');
                }
                loadCars();
            } catch (error) {
                console.error('Error deleting car:', error);
            }
        }

        async function addService() {
            const data = {
                car: selectedCarId,
                work_description: document.getElementById('workDescription').value,
                hours: parseFloat(document.getElementById('workHours').value),
                scheduled_date: document.getElementById('scheduledDate').value
            };
            
            try {
                await apiCall('/cars/services/', 'POST', data);
                closeModal('addServiceModal');
                loadServices(selectedCarId);
            } catch (error) {
                console.error('Error adding service:', error);
                alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ —Ä–æ–±–æ—Ç–∏');
            }
        }

        async function updateServiceStatus(serviceId, newStatus) {
            try {
                await apiCall(`/cars/services/${serviceId}/`, 'PATCH', { status: newStatus });
                loadServices(selectedCarId);
            } catch (error) {
                console.error('Error updating service status:', error);
            }
        }

        async function deleteService(serviceId) {
            if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ä–æ–±–æ—Ç—É?')) return;
            
            try {
                await apiCall(`/cars/services/${serviceId}/`, 'DELETE');
                loadServices(selectedCarId);
            } catch (error) {
                console.error('Error deleting service:', error);
            }
        }

        // Modal functions
        function showAddCarModal() {
            document.getElementById('addCarModal').classList.add('active');
            document.getElementById('carBrand').value = '';
            document.getElementById('carModel').innerHTML = '<option value="">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –±—Ä–µ–Ω–¥</option>';
            document.getElementById('initialMileage').value = '';
            document.getElementById('currentMileage').value = '';
        }

        function showAddServiceModal() {
            if (!selectedCarId) {
                alert('–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –∞–≤—Ç–æ–º–æ–±—ñ–ª—å');
                return;
            }
            document.getElementById('addServiceModal').classList.add('active');
            document.getElementById('workDescription').value = '';
            document.getElementById('workHours').value = '';
            document.getElementById('scheduledDate').value = new Date().toISOString().split('T')[0];
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Enter key support
        document.getElementById('password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });
    </script>
</body>
</html>